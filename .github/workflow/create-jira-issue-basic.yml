name: ê¹ƒí—ˆë¸Œ ì´ìŠˆ -> Jira ë‚´ íƒœìŠ¤í¬ë¡œ ìë™ ìƒì„±

on:
  issues:
    types:
      - opened

permissions:
  issues: write
  contents: write

jobs:
  create-jira-task:
    name: ì§€ë¼ íƒœìŠ¤í¬ ë§Œë“¤ê¸°
    runs-on: ubuntu-latest

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: ì§€ë¼ ë¡œê·¸ì¸
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: ê¹ƒí—ˆë¸Œ ì´ìŠˆ í…œí”Œë¦¿ íŒŒì‹±
        uses: stefanbuck/github-issue-praser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/1-issue-form.yml

      - name: ê¹ƒí—ˆë¸Œ ì´ìŠˆ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì§€ë¼ìš©ìœ¼ë¡œ ë³€í™˜
        uses: peter-evans/jira2md@v1
        id: md2jira
        with:
          input-text: |
            ### ğŸ“ ê´€ë ¨ ì´ìŠˆ
            - ${{ github.event.issue.html_url }}

            ${{ github.event.issue.body }}
          mode: md2jira

      - name: ì§€ë¼ì—ì„œ íƒœìŠ¤í¬ ìƒì„±
        id: create
        uses: atlassian/gajira-create@v3
        with:
          project: WEB
          issuetype: Task
          summary: '${{ github.event.issue.title }}'
          description: '${{ steps.md2jira.outputs.output-text }}'
          fields: |
            {
              "parent": {
                "key": "${{ steps.issue-parser.outputs.issueparser_parentKey }}"
              }
            }
      
      # ì•ì„œ ì§€ë¼ì—ì„œ ìƒì„±í•œ í‹°ì¼“ ë„˜ë²„ë¡œ feat/{í‹°ì¼“ë„˜ë²„} í˜•ì‹ì˜ ë¸Œëœì¹˜ ìƒì„±
      - name: ë¸Œëœì¹˜ ìƒì„±
              run: |
                JIRA_ISSUE="${{ steps.create.outputs.issue }}"
                BRANCH_NAME="feat/${JIRA_ISSUE}"
                git config user.name "github-actions"
                git config user.email "actions@github.com"
                git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}.git
                git checkout -b "$BRANCH_NAME"
                git push origin "$BRANCH_NAME"

      # ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì œëª©ì— ì§€ë¼ í‹°ì¼“ ë„˜ë²„ ì¶”ê°€
      - name: ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-issue'
          token: ${{ secrets.PERSONAL_TOKEN }}
          title: '[${{ steps.create.outputs.issue }}] ${{ github.event.issue.title }}'

      - name: ì§€ë¼ íƒœìŠ¤í¬ ë§í¬ ê¹ƒí—ˆë¸Œ ì´ìŠˆ ëŒ“ê¸€ì— ì¶”ê°€
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.PERSONAL_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸ§¾ **Jiraì—ë„ íƒœìŠ¤í¬ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ğŸŒŸ**  
            ğŸ”— [${{ steps.create.outputs.issue }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create.outputs.issue }})